---
import type { GetStaticPaths } from "astro";
import MarkdownContent from "../../components/MarkdownContent.astro";
import ProjectLayout from "../../layouts/ProjectLayout.astro";
import { allCaseStudies } from "../../content/caseStudies";
import type { CaseStudy } from "../../content/caseStudies/types";

export const getStaticPaths = (() =>
  allCaseStudies.map((caseStudy) => ({
    params: { slug: caseStudy.slug },
    props: { caseStudy },
  }))) satisfies GetStaticPaths;

const { caseStudy } = Astro.props as { caseStudy: CaseStudy };

const MARQUEE_REPEAT = 100;
const MARQUEE_SECONDS_PER_ITEM = 3;
const marqueeBase = caseStudy.role.split("•").map((item) => item.trim());
const marqueeItems = Array.from({ length: MARQUEE_REPEAT }, () => marqueeBase).flat();
const marqueeDuration = `${marqueeItems.length * MARQUEE_SECONDS_PER_ITEM}s`;

const techStack = caseStudy.techStack;
const problem = caseStudy.problemSolution.problem;
const solution = caseStudy.problemSolution.solution;
const technicalWhy = caseStudy.problemSolution.technicalWhy;
const flowNote = caseStudy.systemOverview.flowNote;

const scope = [
  "Product design + UX",
  "Full-stack implementation (Next.js + Supabase)",
  "Ranked feed retrieval + save-state cache pre-hydration",
  "Supplier publishing: multi-step batch uploads + supplier crediting",
  "End-to-end validation + access control",
];

const goals = [
  "Turn inspiration into real purchases via local supplier links",
  "Keep supplier publishing friction low while maintaining data integrity",
  "Keep the feed fast and relevant with clear, testable ranking signals",
  "Maintain a type-safe, layered architecture across client/server/DB",
];

const outcomes = caseStudy.outcomes.map((item) => (typeof item === "string" ? item : item.text));

const links = [
  { label: "Docs", href: "/wedding-ready/README.md" },
  { label: "Tech stack", href: "/wedding-ready/tech-stack.md" },
  { label: "Architecture", href: "/wedding-ready/architecture.md" },
].filter((item) => item.href);

const related = [
  { label: "With Thanks", href: "/projects/with-thanks-v4" },
];
---

<ProjectLayout title={`${caseStudy.name} — Case Study`}>
  <main id={caseStudy.slug} class="grid min-h-screen grid-cols-2 gap-px bg-black">
    <section
      class="col-span-full bg-(--image-bg) px-6 py-0"
      style="height: var(--nav-height);"
    >
      <a
        href="/"
        class="inline-flex h-full items-center gap-2 text-[0.7rem] font-semibold tracking-[0.22em] text-(--description-text) uppercase"
      >
        <span>←</span>
        Back
      </a>
    </section>

    <section
      class="col-span-full grid aspect-2/1 max-h-[25dvh] w-full place-items-center bg-(--brand-bg) p-6 sm:p-12"
    >
      <div class="grid max-w-2xl gap-6 text-center">
        <h1
          class="text-[0.82rem] font-medium tracking-[0.35em] text-(--brand-text) uppercase"
        >
          {caseStudy.name}
        </h1>
        <p class="text-balance text-sm font-normal leading-relaxed text-(--brand-text)/75">
          {caseStudy.oneLiner}
        </p>
      </div>
    </section>

    <section class="col-span-full overflow-x-clip bg-(--brand-bg) p-0">
      <div
        class="project-marquee overflow-x-hidden overflow-y-clip whitespace-nowrap"
        style={`--project-marquee-duration: ${marqueeDuration};`}
        aria-label={`Roles: ${marqueeBase.join(", ")}`}
      >
        <div class="project-marquee-track flex w-max p-0">
          <div
            class="project-marquee-group flex items-start gap-x-10"
            aria-hidden="true"
          >
            {
              marqueeItems.map((item) => (
                <p class="text-4xl leading-none font-extrabold tracking-[0.2em] text-(--description-bg) uppercase">
                  {item}
                </p>
              ))
            }
          </div>
          <div
            class="project-marquee-group flex items-start gap-x-10"
            aria-hidden="true"
          >
            {
              marqueeItems.map((item) => (
                <p class="text-4xl leading-none font-extrabold tracking-[0.2em] text-(--brand-text) uppercase">
                  {item}
                </p>
              ))
            }
          </div>
        </div>
      </div>
    </section>

    <section class="bg-(--image-bg) sm:col-span-1 sm:row-span-2">
      <div class="sticky top-0 grid gap-12 p-6 sm:p-12">
        <section class="flex flex-col gap-10 text-sm leading-relaxed font-normal text-(--description-text)">
          <div class="flex w-full flex-col gap-5">
            <h3 class="font-light text-(--description-text)">
              Problem
            </h3>
            <MarkdownContent value={problem} />
          </div>
          <div class="flex w-full flex-col gap-5">
            <h3 class="font-light text-(--description-text)">
              Solution
            </h3>
            <MarkdownContent value={solution} />
          </div>
          {
            technicalWhy && (
              <div class="flex w-full flex-col gap-5">
                <h3 class="font-light text-(--description-text)">
                  Technical Why
                </h3>
                <MarkdownContent value={technicalWhy} />
              </div>
            )
          }
        </section>
      </div>
    </section>

    <section class="flex flex-col gap-5 bg-(--image-bg) p-6 text-(--description-text) sm:p-12">
      <h3 class="font-light text-(--description-text)">
        Tech Stack
      </h3>
      <ul class="flex w-full list-disc flex-col gap-3 pl-5 text-sm leading-relaxed font-normal marker:text-(--description-text)">
        {techStack.map((item) => <li><MarkdownContent value={item} /></li>)}
      </ul>
    </section>

    <section class="col-span-full bg-(--image-bg) p-6 text-(--description-text) sm:col-span-1 sm:p-12">
      <div class="grid gap-10">
        <div class="flex flex-col gap-3">
          <div class="overflow-hidden rounded-4xl bg-(--image-frame-bg)">
            <img
              src={caseStudy.systemOverview.diagram.src}
              alt={caseStudy.systemOverview.diagram.alt}
              width="1024"
              height="1536"
              class="h-full w-full object-cover"
              loading="lazy"
              decoding="async"
            />
          </div>
          {
            caseStudy.systemOverview.diagram.caption && (
              <p class="px-4 text-pretty text-xs leading-relaxed font-normal text-(--description-text)/75">
                {caseStudy.systemOverview.diagram.caption}
              </p>
            )
          }
        </div>
        {
          flowNote && (
            <div class="grid gap-5 text-sm leading-relaxed font-normal text-(--description-text)">
              <MarkdownContent value={flowNote} />
            </div>
          )
        }
      </div>
    </section>
    <section class="bg-(--description-bg) p-6 sm:p-12">
      <h3 class="text-[0.8rem] font-semibold tracking-[0.22em] uppercase">
        Scope
      </h3>
      <ul class="mt-4 space-y-2 text-[0.95rem]">
        {scope.map((item) => <li>{item}</li>)}
      </ul>
    </section>
    <section class="bg-(--description-bg) p-6 sm:p-12">
      <h3 class="text-[0.8rem] font-semibold tracking-[0.22em] uppercase">
        Goals
      </h3>
      <ul class="mt-4 space-y-2 text-[0.95rem]">
        {goals.map((item) => <li>{item}</li>)}
      </ul>
    </section>
    <section class="bg-(--brand-bg) p-6 text-(--brand-text) sm:p-12">
      <h3 class="text-[0.8rem] font-semibold tracking-[0.22em] uppercase">
        Outcomes
      </h3>
      <ul class="mt-4 space-y-2 text-[0.95rem]">
        {outcomes.map((item) => <li>{item}</li>)}
      </ul>
    </section>

    <section class="grid gap-px bg-black sm:grid-cols-[1.2fr_0.8fr]">
      <div class="bg-(--description-bg) p-6 sm:p-12">
        <h3 class="text-[0.8rem] font-semibold tracking-[0.22em] uppercase">
          Links
        </h3>
        <div
          class="mt-4 flex flex-wrap gap-4 text-[0.9rem] font-semibold tracking-[0.18em] uppercase"
        >
          {
            links.map((link) => (
              <a class="underline underline-offset-4" href={link.href}>
                {link.label}
              </a>
            ))
          }
        </div>
      </div>
      <div class="bg-(--description-bg) p-6 sm:p-12">
        <h3 class="text-[0.8rem] font-semibold tracking-[0.22em] uppercase">
          Next
        </h3>
        <div class="mt-4 space-y-3">
          {
            related.map((item) => (
              <a
                href={item.href}
                class="block text-[0.95rem] font-semibold tracking-[0.18em] uppercase underline underline-offset-4"
              >
                {item.label}
              </a>
            ))
          }
        </div>
      </div>
    </section>
  </main>
</ProjectLayout>
