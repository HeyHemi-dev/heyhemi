---
import type { GetStaticPaths } from "astro";
import ContentBlock from "../../components/ContentBlock.astro";
import Heading from "../../components/Heading.astro";
import MarkdownContent from "../../components/MarkdownContent.astro";
import Panel from "../../components/Panel.astro";
import ProjectLayout from "../../layouts/ProjectLayout.astro";
import { allCaseStudies } from "../../content/caseStudies";
import type { CaseStudy } from "../../content/caseStudies/types";

export const getStaticPaths = (() =>
  allCaseStudies.map((caseStudy, index) => ({
    params: { slug: caseStudy.slug },
    props: { caseStudy, index },
  }))) satisfies GetStaticPaths;

const { caseStudy, index } = Astro.props as {
  caseStudy: CaseStudy;
  index: number;
};

const MARQUEE_REPEAT = 100;
const MARQUEE_SECONDS_PER_ITEM = 3;
const marqueeBase = caseStudy.role.split("•").map((item) => item.trim());
const marqueeItems = Array.from(
  { length: MARQUEE_REPEAT },
  () => marqueeBase,
).flat();
const marqueeDuration = `${marqueeItems.length * MARQUEE_SECONDS_PER_ITEM}s`;

const techStack = caseStudy.techStack;
const problem = caseStudy.problemSolution.problem;
const solution = caseStudy.problemSolution.solution;
const technicalWhy = caseStudy.problemSolution.technicalWhy;
const flowNote = caseStudy.architecture.flowNote;
const deepDive = caseStudy.deepDive;
const outcomes = caseStudy.outcomes;

const previous = allCaseStudies[index - 1];
const next = allCaseStudies[index + 1];
---

<ProjectLayout title={`${caseStudy.name} — Case Study`}>
  <main
    id={caseStudy.slug}
    class="grid min-h-screen grid-cols-2 gap-px bg-black"
  >
    <section
      class="col-span-full bg-(--image-bg) px-6 py-0"
      style="height: var(--nav-height);"
    >
      <a
        href="/"
        class="inline-flex h-full items-center gap-2 text-[0.7rem] font-semibold tracking-[0.22em] text-(--description-text) uppercase"
      >
        <span>←</span>
        Home
      </a>
    </section>

    <Panel
      as="section"
      background="primary"
      class="col-span-full grid aspect-2/1 max-h-[25dvh] w-full place-items-center"
    >
      <div class="grid max-w-2xl gap-6 text-center">
        <Heading
          as="h1"
          style="h4"
          class="text-[0.82rem] font-medium tracking-[0.35em] text-(--brand-text) uppercase"
        >
          {caseStudy.name}
        </Heading>
        <p
          class="text-sm leading-relaxed font-normal text-balance text-(--brand-text)/75"
        >
          {caseStudy.oneLiner}
        </p>
      </div>
    </Panel>

    <Panel as="section" background="primary" class="col-span-full p-0">
      <div
        class="project-marquee overflow-x-clip overflow-y-clip text-4xl leading-none font-extrabold tracking-[0.2em] whitespace-nowrap text-(--description-bg) uppercase"
        style={`--project-marquee-duration: ${marqueeDuration};`}
        role="img"
        aria-label={`Roles: ${marqueeBase.join(", ")}`}
      >
        <div class="project-marquee-track flex w-max p-0" aria-hidden="true">
          <div class="project-marquee-group flex items-start gap-x-10">
            {marqueeItems.map((item) => <p>{item}</p>)}
          </div>
          <div class="project-marquee-group flex items-start gap-x-10">
            {marqueeItems.map((item) => <p>{item}</p>)}
          </div>
        </div>
      </div>
    </Panel>

    <Panel
      as="section"
      class="flex flex-col gap-10 p-6 text-sm leading-relaxed font-normal"
    >
      <div class="flex w-full flex-col gap-5">
        <Heading as="h3" style="h3"> Problem </Heading>
        <MarkdownContent value={problem} />
      </div>
      <div class="flex w-full flex-col gap-5">
        <Heading as="h3" style="h3"> Solution </Heading>
        <MarkdownContent value={solution} />
      </div>
      {
        technicalWhy && (
          <div class="flex w-full flex-col gap-5">
            <Heading as="h3" style="h3">
              Technical Why
            </Heading>
            <MarkdownContent value={technicalWhy} />
          </div>
        )
      }
    </Panel>

    <Panel as="section" class="flex flex-col gap-5">
      <Heading as="h3" style="h3">Tech Stack</Heading>
      <ul
        class="flex w-full flex-col gap-5 text-sm leading-relaxed font-normal"
      >
        {
          techStack.map((item) => (
            <li>
              <MarkdownContent value={item} />
            </li>
          ))
        }
      </ul>
    </Panel>

    <section
      class="col-span-full grid gap-px text-(--description-text) sm:col-span-1"
    >
      <Panel background="accent" as="header">
        <Heading style="h2"> Architecture </Heading>
      </Panel>
      <Panel as="div" class="grid gap-10">
        <div class="flex flex-col gap-3">
          <div class="overflow-hidden rounded-4xl bg-(--image-frame-bg)">
            <img
              src={caseStudy.architecture.diagram.src}
              alt={caseStudy.architecture.diagram.alt}
              width="1024"
              height="1536"
              class="h-full w-full object-cover"
              loading="lazy"
              decoding="async"
            />
          </div>
          {
            caseStudy.architecture.diagram.caption && (
              <p class="px-4 text-xs leading-relaxed font-normal text-pretty text-(--description-text)/75">
                {caseStudy.architecture.diagram.caption}
              </p>
            )
          }
        </div>
        {
          flowNote && (
            <div class="grid gap-5 text-sm leading-relaxed font-normal">
              <MarkdownContent value={flowNote} />
            </div>
          )
        }
      </Panel>
    </section>
    <section data-eng-decisions class="col-span-full grid gap-px">
      <Panel background="accent" as="header" data-eng-decisions-title>
        <Heading style="h2"> Engineering </Heading>
      </Panel>

      <div
        data-eng-decisions-scroll
        class="w-full overflow-x-auto overscroll-x-contain"
      >
        <div data-eng-decisions-grid class="grid min-w-4xl grid-cols-3 gap-px">
          <header
            data-eng-decisions-head
            class="col-span-full grid grid-cols-subgrid"
          >
            <Panel background="secondary" as="div">
              <Heading as="p" style="h4">Constraint</Heading>
            </Panel>
            <Panel background="secondary" as="div">
              <Heading as="p" style="h4">Decision</Heading>
            </Panel>
            <Panel background="secondary" as="div">
              <Heading as="p" style="h4">Trade-off</Heading>
            </Panel>
          </header>

          {
            caseStudy.engineering.rows.map((row, index) => (
              <article
                data-eng-decisions-row={index}
                class="col-span-full grid grid-cols-subgrid text-sm leading-relaxed font-normal"
              >
                <Panel as="div">
                  <MarkdownContent value={row.constraint} />
                </Panel>
                <Panel as="div">
                  <MarkdownContent value={row.decision} />
                </Panel>
                <Panel as="div">
                  <MarkdownContent value={row.tradeOff} />
                </Panel>
              </article>
            ))
          }
        </div>
      </div>
    </section>
    <section class="col-span-full grid min-w-0 gap-px">
      <Panel as="header" background="accent" class="grid gap-3">
        <Heading as="p" style="h4">Deep Dive</Heading>
        <Heading style="h2">
          {deepDive.title}
        </Heading>
      </Panel>
      <Panel as="div" class="grid gap-5 text-sm leading-relaxed font-normal">
        {deepDive.content.map((block) => <ContentBlock block={block} />)}
      </Panel>
    </section>

    <section class="col-span-full grid grid-cols-subgrid gap-px">
      <Panel background="accent" as="header" class="col-span-full">
        <Heading style="h2"> More projects </Heading>
      </Panel>
      <Panel
        background="secondary"
        as="div"
        class="grid aspect-square place-items-center"
      >
        {
          previous && (
            <a href={`/projects/${previous.slug}`}>
              <Heading as="h3" style="h1" aria-label="Previous project">
                &lt;-
              </Heading>
              {previous.name}
            </a>
          )
        }
      </Panel>

      <Panel
        background="secondary"
        as="div"
        class="grid aspect-square place-items-center"
      >
        {
          next && (
            <a href={`/projects/${next.slug}`}>
              <Heading as="h3" style="h1" aria-label="Next project">
                -&gt;
              </Heading>
              {next.name}
            </a>
          )
        }
      </Panel>
    </section>
  </main>
</ProjectLayout>
