---
import type { GetStaticPaths } from "astro";
import { unified } from "unified";
import remarkGfm from "remark-gfm";
import remarkParse from "remark-parse";
import ProjectLayout from "../../layouts/ProjectLayout.astro";
import { allCaseStudies } from "../../content/caseStudies";
import type { CaseStudy } from "../../content/caseStudies/types";

export const getStaticPaths = (() =>
  allCaseStudies.map((caseStudy) => ({
    params: { slug: caseStudy.slug },
    props: { caseStudy },
  }))) satisfies GetStaticPaths;

const { caseStudy } = Astro.props as { caseStudy: CaseStudy };

const MARQUEE_REPEAT = 100;
const MARQUEE_SECONDS_PER_ITEM = 3;
const marqueeBase = caseStudy.role.split("•").map((item) => item.trim());
const marqueeItems = Array.from({ length: MARQUEE_REPEAT }, () => marqueeBase).flat();
const marqueeDuration = `${marqueeItems.length * MARQUEE_SECONDS_PER_ITEM}s`;

const techStack = caseStudy.techStack.map((item) =>
  typeof item === "string" ? item : item.text,
);
const problem =
  typeof caseStudy.problemSolution.problem === "string"
    ? caseStudy.problemSolution.problem
    : caseStudy.problemSolution.problem.text;
const solution =
  typeof caseStudy.problemSolution.solution === "string"
    ? caseStudy.problemSolution.solution
    : caseStudy.problemSolution.solution.text;
const technicalWhy = caseStudy.problemSolution.technicalWhy
  ? typeof caseStudy.problemSolution.technicalWhy === "string"
    ? caseStudy.problemSolution.technicalWhy
    : caseStudy.problemSolution.technicalWhy.text
  : null;
const flowNoteValue = caseStudy.systemOverview.flowNote;
const flowNoteText = flowNoteValue
  ? typeof flowNoteValue === "string"
    ? flowNoteValue
    : flowNoteValue.text
  : "";
const flowNoteIsMarkdown =
  Boolean(flowNoteValue) &&
  typeof flowNoteValue !== "string" &&
  ((flowNoteValue as { type?: string }).type === "md" ||
    (flowNoteValue as { format?: string }).format === "md");

const flowNoteAst =
  flowNoteIsMarkdown && flowNoteText
    ? (unified().use(remarkParse).use(remarkGfm).parse(flowNoteText) as { children: any[] })
    : null;

type MarkdownInlineToken =
  | { type: "text"; value: string }
  | { type: "strong"; value: string }
  | { type: "emphasis"; value: string }
  | { type: "inlineCode"; value: string }
  | { type: "link"; value: string; url: string }
  | { type: "delete"; value: string }
  | { type: "break" };

type MarkdownBlockToken =
  | { type: "paragraph"; inlines: MarkdownInlineToken[] }
  | { type: "heading"; depth: 2 | 3 | 4; inlines: MarkdownInlineToken[] }
  | { type: "list"; ordered: boolean; items: MarkdownInlineToken[][] }
  | { type: "code"; value: string }
  | { type: "hr" };

function toPlainText(children: any[] = []): string {
  return children
    .map((child) => {
      if (!child) return "";
      if (child.type === "text" || child.type === "inlineCode") return child.value ?? "";
      if (Array.isArray(child.children)) return toPlainText(child.children);
      return "";
    })
    .join("");
}

function toInlineToken(node: any): MarkdownInlineToken | null {
  if (!node) return null;
  if (node.type === "text") return { type: "text", value: node.value ?? "" };
  if (node.type === "strong") return { type: "strong", value: toPlainText(node.children) };
  if (node.type === "emphasis") return { type: "emphasis", value: toPlainText(node.children) };
  if (node.type === "inlineCode") return { type: "inlineCode", value: node.value ?? "" };
  if (node.type === "link") {
    return {
      type: "link",
      value: toPlainText(node.children),
      url: node.url ?? "#",
    };
  }
  if (node.type === "delete") return { type: "delete", value: toPlainText(node.children) };
  if (node.type === "break") return { type: "break" };
  return null;
}

function toInlineTokens(nodes: any[] = []): MarkdownInlineToken[] {
  return nodes.map((node) => toInlineToken(node)).filter(Boolean) as MarkdownInlineToken[];
}

function toListItemInlines(listItem: any): MarkdownInlineToken[] {
  const tokens: MarkdownInlineToken[] = [];
  for (const child of listItem.children ?? []) {
    if (child.type === "paragraph") {
      tokens.push(...toInlineTokens(child.children));
    } else {
      const token = toInlineToken(child);
      if (token) tokens.push(token);
    }
  }
  return tokens;
}

function toMarkdownBlock(node: any): MarkdownBlockToken | null {
  if (!node) return null;
  if (node.type === "paragraph") return { type: "paragraph", inlines: toInlineTokens(node.children) };
  if (node.type === "heading") {
    const depth = Math.min(Math.max(node.depth ?? 3, 2), 4) as 2 | 3 | 4;
    return { type: "heading", depth, inlines: toInlineTokens(node.children) };
  }
  if (node.type === "list") {
    return {
      type: "list",
      ordered: Boolean(node.ordered),
      items: (node.children ?? []).map((listItem: any) => toListItemInlines(listItem)),
    };
  }
  if (node.type === "code") return { type: "code", value: node.value ?? "" };
  if (node.type === "thematicBreak") return { type: "hr" };
  return null;
}

const flowNoteMarkdownBlocks = flowNoteAst
  ? flowNoteAst.children
      .map((node) => toMarkdownBlock(node))
      .filter(Boolean) as MarkdownBlockToken[]
  : [];

const scope = [
  "Product design + UX",
  "Full-stack implementation (Next.js + Supabase)",
  "Ranked feed retrieval + save-state cache pre-hydration",
  "Supplier publishing: multi-step batch uploads + supplier crediting",
  "End-to-end validation + access control",
];

const goals = [
  "Turn inspiration into real purchases via local supplier links",
  "Keep supplier publishing friction low while maintaining data integrity",
  "Keep the feed fast and relevant with clear, testable ranking signals",
  "Maintain a type-safe, layered architecture across client/server/DB",
];

const outcomes = caseStudy.outcomes.map((item) => (typeof item === "string" ? item : item.text));

const links = [
  { label: "Docs", href: "/wedding-ready/README.md" },
  { label: "Tech stack", href: "/wedding-ready/tech-stack.md" },
  { label: "Architecture", href: "/wedding-ready/architecture.md" },
].filter((item) => item.href);

const related = [
  { label: "With Thanks", href: "/projects/with-thanks-v4" },
];
---

<ProjectLayout title={`${caseStudy.name} — Case Study`}>
  <main id={caseStudy.slug} class="grid min-h-screen grid-cols-2 gap-px bg-black">
    <section
      class="col-span-full bg-(--image-bg) px-6 py-0"
      style="height: var(--nav-height);"
    >
      <a
        href="/"
        class="inline-flex h-full items-center gap-2 text-[0.7rem] font-semibold tracking-[0.22em] text-(--description-text) uppercase"
      >
        <span>←</span>
        Back
      </a>
    </section>

    <section
      class="col-span-full grid aspect-2/1 max-h-[25dvh] w-full place-items-center bg-(--brand-bg) p-6 sm:p-12"
    >
      <div class="grid max-w-2xl gap-6 text-center">
        <h1
          class="text-[0.82rem] font-medium tracking-[0.35em] text-(--brand-text) uppercase"
        >
          {caseStudy.name}
        </h1>
        <p class="text-balance text-sm font-normal leading-relaxed text-(--brand-text)/75">
          {caseStudy.oneLiner}
        </p>
      </div>
    </section>

    <section class="col-span-full overflow-x-clip bg-(--brand-bg) p-0">
      <div
        class="project-marquee overflow-x-hidden overflow-y-clip whitespace-nowrap"
        style={`--project-marquee-duration: ${marqueeDuration};`}
        aria-label={`Roles: ${marqueeBase.join(", ")}`}
      >
        <div class="project-marquee-track flex w-max p-0">
          <div
            class="project-marquee-group flex items-start gap-x-10"
            aria-hidden="true"
          >
            {
              marqueeItems.map((item) => (
                <p class="text-4xl leading-none font-extrabold tracking-[0.2em] text-(--description-bg) uppercase">
                  {item}
                </p>
              ))
            }
          </div>
          <div
            class="project-marquee-group flex items-start gap-x-10"
            aria-hidden="true"
          >
            {
              marqueeItems.map((item) => (
                <p class="text-4xl leading-none font-extrabold tracking-[0.2em] text-(--brand-text) uppercase">
                  {item}
                </p>
              ))
            }
          </div>
        </div>
      </div>
    </section>

    <section class="bg-(--image-bg) sm:col-span-1 sm:row-span-2">
      <div class="sticky top-0 grid gap-12 p-6 sm:p-12">
        <section class="flex flex-col gap-10">
          <div class="flex w-full flex-col gap-5">
            <h3 class="font-light text-(--description-text)">
              Problem
            </h3>
            <p class="text-sm leading-relaxed font-normal">{problem}</p>
          </div>
          <div class="flex w-full flex-col gap-5">
            <h3 class="font-light text-(--description-text)">
              Solution
            </h3>
            <p class="text-sm leading-relaxed font-normal">{solution}</p>
          </div>
          {
            technicalWhy && (
              <div class="flex w-full flex-col gap-5">
                <h3 class="font-light text-(--description-text)">
                  Technical Why
                </h3>
                <p class="text-sm leading-relaxed font-normal">{technicalWhy}</p>
              </div>
            )
          }
        </section>
      </div>
    </section>

    <section class="flex flex-col gap-5 bg-(--image-bg) p-6 sm:p-12">
      <h3 class="font-light text-(--description-text)">
        Tech Stack
      </h3>
      <ul class="flex w-full list-disc flex-col gap-3 pl-5 text-sm leading-relaxed font-normal marker:text-(--description-text)">
        {techStack.map((item) => <li>{item}</li>)}
      </ul>
    </section>

    <section class="col-span-full bg-(--image-bg) p-6 sm:col-span-1 sm:p-12">
      <div class="grid gap-10">
        <div class="flex flex-col gap-3">
          <div class="overflow-hidden rounded-4xl bg-(--image-frame-bg)">
            <img
              src={caseStudy.systemOverview.diagram.src}
              alt={caseStudy.systemOverview.diagram.alt}
              width="1024"
              height="1536"
              class="h-full w-full object-cover"
              loading="lazy"
              decoding="async"
            />
          </div>
          {
            caseStudy.systemOverview.diagram.caption && (
              <p class="px-4 text-pretty text-xs leading-relaxed font-normal text-(--description-text)/75">
                {caseStudy.systemOverview.diagram.caption}
              </p>
            )
          }
        </div>
        {
          flowNoteText &&
            (flowNoteIsMarkdown ? (
              <div class="grid gap-5">
                {
                  flowNoteMarkdownBlocks.map((block) => {
                    if (block.type === "paragraph") {
                      return (
                        <p class="text-sm leading-relaxed font-normal text-(--description-text)">
                          {
                            block.inlines.map((token) => {
                              if (token.type === "text") return token.value;
                              if (token.type === "strong") return <strong>{token.value}</strong>;
                              if (token.type === "emphasis") return <em>{token.value}</em>;
                              if (token.type === "inlineCode") {
                                return (
                                  <code class="rounded bg-black/10 px-1 py-0.5 font-mono text-[0.9em]">
                                    {token.value}
                                  </code>
                                );
                              }
                              if (token.type === "link") {
                                return (
                                  <a href={token.url} class="underline underline-offset-2">
                                    {token.value}
                                  </a>
                                );
                              }
                              if (token.type === "delete") return <del>{token.value}</del>;
                              if (token.type === "break") return <br />;
                              return null;
                            })
                          }
                        </p>
                      );
                    }
                    if (block.type === "heading") {
                      if (block.depth === 2) {
                        return (
                          <h2 class="font-light text-(--description-text)">
                            {
                              block.inlines.map((token) =>
                                token.type === "text" ? token.value : token.type === "inlineCode" ? (
                                  <code class="rounded bg-black/10 px-1 py-0.5 font-mono text-[0.9em]">
                                    {token.value}
                                  </code>
                                ) : token.type === "strong" ? (
                                  <strong>{token.value}</strong>
                                ) : token.type === "emphasis" ? (
                                  <em>{token.value}</em>
                                ) : token.type === "delete" ? (
                                  <del>{token.value}</del>
                                ) : token.type === "link" ? (
                                  <a href={token.url} class="underline underline-offset-2">
                                    {token.value}
                                  </a>
                                ) : token.type === "break" ? (
                                  <br />
                                ) : null,
                              )
                            }
                          </h2>
                        );
                      }
                      if (block.depth === 3) {
                        return (
                          <h3 class="font-light text-(--description-text)">
                            {
                              block.inlines.map((token) =>
                                token.type === "text" ? token.value : token.type === "inlineCode" ? (
                                  <code class="rounded bg-black/10 px-1 py-0.5 font-mono text-[0.9em]">
                                    {token.value}
                                  </code>
                                ) : token.type === "strong" ? (
                                  <strong>{token.value}</strong>
                                ) : token.type === "emphasis" ? (
                                  <em>{token.value}</em>
                                ) : token.type === "delete" ? (
                                  <del>{token.value}</del>
                                ) : token.type === "link" ? (
                                  <a href={token.url} class="underline underline-offset-2">
                                    {token.value}
                                  </a>
                                ) : token.type === "break" ? (
                                  <br />
                                ) : null,
                              )
                            }
                          </h3>
                        );
                      }
                      return (
                        <h4 class="font-light text-(--description-text)">
                          {
                            block.inlines.map((token) =>
                              token.type === "text" ? token.value : token.type === "inlineCode" ? (
                                <code class="rounded bg-black/10 px-1 py-0.5 font-mono text-[0.9em]">
                                  {token.value}
                                </code>
                              ) : token.type === "strong" ? (
                                <strong>{token.value}</strong>
                              ) : token.type === "emphasis" ? (
                                <em>{token.value}</em>
                              ) : token.type === "delete" ? (
                                <del>{token.value}</del>
                              ) : token.type === "link" ? (
                                <a href={token.url} class="underline underline-offset-2">
                                  {token.value}
                                </a>
                              ) : token.type === "break" ? (
                                <br />
                              ) : null,
                            )
                          }
                        </h4>
                      );
                    }
                    if (block.type === "list") {
                      return block.ordered ? (
                        <ol class="flex list-decimal flex-col gap-3 pl-5 text-sm leading-relaxed font-normal text-(--description-text)">
                          {
                            block.items.map((item) => (
                              <li>
                                {
                                  item.map((token) =>
                                    token.type === "text" ? token.value : token.type === "inlineCode" ? (
                                      <code class="rounded bg-black/10 px-1 py-0.5 font-mono text-[0.9em]">
                                        {token.value}
                                      </code>
                                    ) : token.type === "strong" ? (
                                      <strong>{token.value}</strong>
                                    ) : token.type === "emphasis" ? (
                                      <em>{token.value}</em>
                                    ) : token.type === "delete" ? (
                                      <del>{token.value}</del>
                                    ) : token.type === "link" ? (
                                      <a href={token.url} class="underline underline-offset-2">
                                        {token.value}
                                      </a>
                                    ) : token.type === "break" ? (
                                      <br />
                                    ) : null,
                                  )
                                }
                              </li>
                            ))
                          }
                        </ol>
                      ) : (
                        <ul class="flex list-disc flex-col gap-3 pl-5 text-sm leading-relaxed font-normal text-(--description-text)">
                          {
                            block.items.map((item) => (
                              <li>
                                {
                                  item.map((token) =>
                                    token.type === "text" ? token.value : token.type === "inlineCode" ? (
                                      <code class="rounded bg-black/10 px-1 py-0.5 font-mono text-[0.9em]">
                                        {token.value}
                                      </code>
                                    ) : token.type === "strong" ? (
                                      <strong>{token.value}</strong>
                                    ) : token.type === "emphasis" ? (
                                      <em>{token.value}</em>
                                    ) : token.type === "delete" ? (
                                      <del>{token.value}</del>
                                    ) : token.type === "link" ? (
                                      <a href={token.url} class="underline underline-offset-2">
                                        {token.value}
                                      </a>
                                    ) : token.type === "break" ? (
                                      <br />
                                    ) : null,
                                  )
                                }
                              </li>
                            ))
                          }
                        </ul>
                      );
                    }
                    if (block.type === "code") {
                      return (
                        <pre class="overflow-x-auto rounded-lg bg-black/10 p-4 text-sm leading-relaxed font-normal">
                          <code>{block.value}</code>
                        </pre>
                      );
                    }
                    if (block.type === "hr") {
                      return <hr class="border-(--description-text)/20" />;
                    }
                    return null;
                  })
                }
              </div>
            ) : (
              <p class="whitespace-pre-line text-sm leading-relaxed font-normal text-(--description-text)">
                {flowNoteText}
              </p>
            ))
        }
      </div>
    </section>
    <section class="bg-(--description-bg) p-6 sm:p-12">
      <h3 class="text-[0.8rem] font-semibold tracking-[0.22em] uppercase">
        Scope
      </h3>
      <ul class="mt-4 space-y-2 text-[0.95rem]">
        {scope.map((item) => <li>{item}</li>)}
      </ul>
    </section>
    <section class="bg-(--description-bg) p-6 sm:p-12">
      <h3 class="text-[0.8rem] font-semibold tracking-[0.22em] uppercase">
        Goals
      </h3>
      <ul class="mt-4 space-y-2 text-[0.95rem]">
        {goals.map((item) => <li>{item}</li>)}
      </ul>
    </section>
    <section class="bg-(--brand-bg) p-6 text-(--brand-text) sm:p-12">
      <h3 class="text-[0.8rem] font-semibold tracking-[0.22em] uppercase">
        Outcomes
      </h3>
      <ul class="mt-4 space-y-2 text-[0.95rem]">
        {outcomes.map((item) => <li>{item}</li>)}
      </ul>
    </section>

    <section class="grid gap-px bg-black sm:grid-cols-[1.2fr_0.8fr]">
      <div class="bg-(--description-bg) p-6 sm:p-12">
        <h3 class="text-[0.8rem] font-semibold tracking-[0.22em] uppercase">
          Links
        </h3>
        <div
          class="mt-4 flex flex-wrap gap-4 text-[0.9rem] font-semibold tracking-[0.18em] uppercase"
        >
          {
            links.map((link) => (
              <a class="underline underline-offset-4" href={link.href}>
                {link.label}
              </a>
            ))
          }
        </div>
      </div>
      <div class="bg-(--description-bg) p-6 sm:p-12">
        <h3 class="text-[0.8rem] font-semibold tracking-[0.22em] uppercase">
          Next
        </h3>
        <div class="mt-4 space-y-3">
          {
            related.map((item) => (
              <a
                href={item.href}
                class="block text-[0.95rem] font-semibold tracking-[0.18em] uppercase underline underline-offset-4"
              >
                {item.label}
              </a>
            ))
          }
        </div>
      </div>
    </section>
  </main>
</ProjectLayout>
